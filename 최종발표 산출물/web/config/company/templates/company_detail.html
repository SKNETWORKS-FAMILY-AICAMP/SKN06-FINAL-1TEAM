{% load static %}

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ì—… ìƒì„¸</title>
    <link rel="stylesheet" href="{% static 'css/header.css' %}">
    <link rel="stylesheet" href="{% static 'css/company_detail.css' %}">
    <link rel="stylesheet" href="{% static 'css/financial.css' %}">
    <link rel="stylesheet" href="{% static 'css/executive_worker.css' %}">
    <link rel="stylesheet" href="{% static 'css/global.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    {% include "header.html" %}

    <!-- JSON ë°ì´í„° ì „ë‹¬ -->
    {{ financial_health_metrics|json_script:"financialHealthData" }}
    {{ financial_results|json_script:"financialResultsData" }}
    {{ executives|json_script:"executiveData" }}
    {{ workers|json_script:"workerData" }}

    <div class="detail-container">
        <div class="detail-card">
            <h2 class="corp-name">{{ company.corp_name }}</h2>
            <p><strong>ë²•ì¸ì½”ë“œ:</strong> {{ company.corp_code }}</p>
            <p><strong>ì¢…ëª©ì½”ë“œ:</strong> {{ company.stock_code }}</p>
            <p><strong>ëŒ€í‘œìëª…:</strong> {{ company.ceo_nm }}</p>
            <p><strong>ì£¼ì†Œ:</strong> {{ company.adres }}</p>
            <p><strong>í™ˆí˜ì´ì§€:</strong>
                {% if "http" in company.hm_url %}
             <a href="{{ company.hm_url }}" target="_blank" rel="noopener noreferrer">
                    {{ company.hm_url }}
                </a>
            {% else %}
                <a href="http://{{ company.hm_url }}" target="_blank" rel="noopener noreferrer">
                    {{ company.hm_url }}
                </a>
            {% endif %}
            </p>
            <p><strong>ì‚¬ì—…ê°œyo </strong> {{ company.a|safe }}</p>
        </div>
        <div>
        </div>

        <div class="hexagon-chart-container">
            <h3>ì¬ë¬´ ê±´ì „ì„± ì§€í‘œ</h3>
            <canvas id="hexagonChart"></canvas>
        </div>
    </div>

    <!-- ğŸ“Œ ì¬ë¬´ì˜ˆì¸¡ ì°¨íŠ¸ -->
     <div class="revenue-chart-container">
        <h3>ë§¤ì¶œì•¡ ì¶”ì´</h3>
        <h4>(ë³„ë„ì¬ë¬´ì œí‘œ ê¸°ë°˜)</h4>
        <canvas id="revenueChart"></canvas>
     </div>

    <!-- ğŸ“Œ ì¬ë¬´ ì •ë³´ íƒ­ ë²„íŠ¼ -->
    <h3>ì¬ë¬´ ì •ë³´</h3>
    <div class="financial-tabs">
        <button class="tab-button active" data-type="BS_single">ì¬ë¬´ìƒíƒœí‘œ(ë³„ë„)</button>
        <button class="tab-button" data-type="BS_connection">ì¬ë¬´ìƒíƒœí‘œ(ì—°ê²°)</button>
        <button class="tab-button" data-type="IS_single">ì†ìµê³„ì‚°ì„œ(ë³„ë„)</button>
        <button class="tab-button" data-type="IS_connection">ì†ìµê³„ì‚°ì„œ(ì—°ê²°)</button>
        <button class="tab-button" data-type="CF_single">í˜„ê¸ˆíë¦„í‘œ(ë³„ë„)</button>
        <button class="tab-button" data-type="CF_connection">í˜„ê¸ˆíë¦„í‘œ(ì—°ê²°)</button>
    </div>

    <div class="amount-card">
        <table id="financial-table">
            <thead>
                <tr>
                    <th>êµ¬ë¶„</th>
                    <th>2023ë…„ ì´ê¸ˆì•¡</th>
                    <th>2022ë…„ ì´ê¸ˆì•¡</th>
                    <th>2021ë…„ ì´ê¸ˆì•¡</th>
                </tr>
            </thead>
            <tbody id="table-body">
                <!-- ë°ì´í„°ê°€ ì—¬ê¸°ì— ì‚½ì…ë¨ -->
            </tbody>
        </table>
    </div>

    <h3>ì„ì› í˜„í™©</h3>
<div class="executive-card">
    <table id="executive-table">
        <thead>
            <tr>
                <th>ì´ë¦„</th>
                <th>ìƒë…„ì›”ì¼</th>
                <th>ì§ìœ„</th>
                <th>ì¬ì§ê¸°ê°„</th>
            </tr>
        </thead>
        <tbody>
            <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ë¶€ë¶„ -->
        </tbody>
    </table>

    <!-- Pagination ë²„íŠ¼ -->
    <div class="pagination">
        <button id="prev-executive" disabled>â—€ ì´ì „</button>
        <span id="executive-page-info">1 / 1</span>
        <button id="next-executive">ë‹¤ìŒ â–¶</button>
    </div>
</div>

<h3>ì§ì› í˜„í™©</h3>
<div class="worker-card">
    <table id="worker-table">
        <thead>
            <tr>
                <th>ë¶€ì„œ</th>
                <th>ì •ê·œì§</th>
                <th>ë¹„ì •ê·œì§</th>
                <th>ì§ì›ìˆ˜</th>
            </tr>
        </thead>
        <tbody>
            <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì±„ì›Œì§ˆ ë¶€ë¶„ -->
        </tbody>
    </table>

    <!-- Pagination ë²„íŠ¼ -->
    <div class="pagination">
        <button id="prev-worker" disabled>â—€ ì´ì „</button>
        <span id="worker-page-info">1 / 1</span>
        <button id="next-worker">ë‹¤ìŒ â–¶</button>
    </div>
</div>


    <!-- JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            console.log("âœ… í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ!");

            // ğŸ“Œ ê¸°ì—… ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
            const buttons = document.querySelectorAll(".tab-button");
            const tableBody = document.getElementById("table-body");
            const corpCode = "{{ company.corp_code }}"; 

            // JSON ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì„ì› ë° ì§ì›)
            const executiveElement = document.getElementById("executiveData");
            console.log("ddddd:", executiveElement)
            const workerElement = document.getElementById("workerData");

            let executives = [];
            let workers = [];

            if (executiveElement){
                try {
                    executives = JSON.parse(executiveElement.textContent);
                    console.log("ğŸ“Œ ì„ì› ë°ì´í„°:", executives);
                    setupTablePagination(executives, "executive-table", "executive", 5);
                } catch (error) {
                    console.error("ğŸš¨ ì„ì› ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", error);
                }
            }


            if (workerElement){
                try {
                    workers = JSON.parse(workerElement.textContent);
                    console.log("ğŸ“Œ ì§ì› ë°ì´í„°:", workers);
                    setupTablePagination(workers, "worker-table", "worker", 5);
                } catch (error) {
                    console.error("ğŸš¨ ì§ì› ë°ì´í„° íŒŒì‹± ì˜¤ë¥˜:", error);
                }
            }

            // ğŸ“Œ Hexagon Chart ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const financialHealthElement = document.getElementById("financialHealthData");
            if (financialHealthElement) {
                const financialHealthData = JSON.parse(financialHealthElement.textContent);
                console.log('ğŸ“Š ì¬ë¬´ ê±´ì „ì„± ë°ì´í„°:', financialHealthData);

                if (Array.isArray(financialHealthData) && financialHealthData.length > 0) {
                    const labels = ["ìœ ë™ë¹„ìœ¨", "ë¶€ì±„ë¹„ìœ¨", "ìê¸°ìë³¸ì´ìµë¥ (ROE)", "ì´ìì‚°íšŒì „ìœ¨", "ì´ìë³´ìƒë¹„ìœ¨", "ë§¤ì¶œì„±ì¥ë¥ "];
                    const healthMetrics = financialHealthData[0] || {};

                    const values = [
                        healthMetrics.current_ratio ?? 0, 
                        healthMetrics.debt_ratio ?? 0, 
                        healthMetrics.return_on_equity ?? 0,
                        healthMetrics.total_asset_turnover ?? 0,
                        healthMetrics.interest_coverage_ratio ?? 0,
                        healthMetrics.revenue_growth_rate ?? 0
                    ];

                    const hexagonCanvas = document.getElementById('hexagonChart');
                    if (hexagonCanvas) {
                        new Chart(hexagonCanvas.getContext('2d'), {
                            type: 'radar',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: "ì¬ë¬´ ì§€í‘œ",
                                    data: values,
                                    backgroundColor: "rgba(255, 102, 0, 0.2)",
                                    borderColor: "rgba(255, 102, 0, 1)",
                                    borderWidth: 3,
                                    pointBackgroundColor: "rgba(255, 102, 0, 1)",  // ë°ì´í„° ì  ìƒ‰ìƒ
                                    pointBorderColor: "#ffffff",  // í°ìƒ‰ í…Œë‘ë¦¬ 
                                    pointHoverBackgroundColor: "#ffffff",  // í˜¸ë²„1
                                    pointHoverBorderColor: "rgba(255, 102, 0, 1)", // í˜¸ë²„2
                                }]
                            }
                        });
                    }
                }
            }

            // ğŸ“Œ ì¬ë¬´ í…Œì´ë¸” ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (AJAX)
            function fetchFinancialData(reportType) {
                fetch(`/api/financial/${corpCode}/${reportType}/`)
                    .then(response => response.json())
                    .then(data => {
                        tableBody.innerHTML = createTableRows(data);
                        addToggleEventListeners(); // í¼ì¹˜ê¸° ì´ë²¤íŠ¸ ì¶”ê°€
                    })
                    .catch(error => console.error("ğŸš¨ JSON ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:", error));
            }
            function checkAndHideButtons(data) {
        buttons.forEach(button => {
            let reportType = button.getAttribute("data-type");
            
            // í•´ë‹¹ reportType ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë¹„ì–´ ìˆìœ¼ë©´ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            if (!data || Object.keys(data).length === 0) {
                button.style.display = "none";
            } else {
                button.style.display = "inline-block"; // ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë‹¤ì‹œ ë³´ì´ê²Œ
            }
        });
    }

    function createTableRows(data, level = 0, parentKey = "") {
                let rows = "";

                for (let key in data) {
                    if (key === "amounts") continue;

                    if (typeof data[key] === "object" && data[key] !== null) {
                        let rowKey = parentKey ? `${parentKey}-${key}` : key;
                        let padding = 20 * level;

                        // ğŸ”¹ í•˜ìœ„ í•­ëª©ì´ ìˆëŠ”ì§€ í™•ì¸ (amountsë¥¼ ì œì™¸í•œ í‚¤ê°€ ìˆëŠ” ê²½ìš°)
                        let hasChildren = Object.keys(data[key]).some(k => k !== "amounts" && typeof data[key][k] === "object");

                        // ğŸ“Œ í•˜ìœ„ í•­ëª©ì´ ìˆëŠ” ê²½ìš°ì—ë§Œ í† ê¸€ ë²„íŠ¼ ì¶”ê°€
                        let toggleButton = hasChildren ? `<span class="toggle-button">â–¶</span>` : "";

                        // âœ… ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê²¨ì§„ ìƒíƒœ (tr ìš”ì†Œì— 'hidden-row' í´ë˜ìŠ¤ ì¶”ê°€)
                        rows += `
                            <tr data-key="${rowKey}" class="category collapsed">
                                <td style="padding-left:${padding}px; text-align:left; cursor:pointer;">
                                    ${toggleButton} ${key}
                                </td>
                                <td>${data[key].amounts ? (data[key].amounts.amount_2023?.toLocaleString() || '-') : '-'}</td>
                                <td>${data[key].amounts ? (data[key].amounts.amount_2022?.toLocaleString() || '-') : '-'}</td>
                                <td>${data[key].amounts ? (data[key].amounts.amount_2021?.toLocaleString() || '-') : '-'}</td>
                            </tr>
                        `;

                        if (hasChildren) {
                            rows += createTableRows(data[key], level + 1, rowKey);
                        }
                    }
                }
                return rows;
            }

    function addToggleEventListeners() {
        document.querySelectorAll(".category").forEach(row => {
            let key = row.getAttribute("data-key");
            let subRows = document.querySelectorAll(`tr[data-key^="${key}-"]`);

            // âœ… ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  í•˜ìœ„ í•­ëª©ì„ ìˆ¨ê¹€
            subRows.forEach(subRow => subRow.classList.add("hidden-row"));

            row.addEventListener("click", function () {
                let isExpanded = this.classList.contains("expanded");

                let toggleIcon = this.querySelector(".toggle-button");
                if (toggleIcon) {
                    toggleIcon.textContent = isExpanded ? "â–¶" : "â–¼";
                }

                subRows.forEach(subRow => {
                    subRow.classList.toggle("hidden-row");
                });

                this.classList.toggle("expanded");
                this.classList.toggle("collapsed");
            });
        });
    }

    function setupTablePagination(data, tableId, type, rowsPerPage) {
        const tableBody = document.querySelector(`#${tableId} tbody`);
        const prevButton = document.getElementById(`prev-${type}`);
        const nextButton = document.getElementById(`next-${type}`);
        const pageInfo = document.getElementById(`${type}-page-info`);

        let currentPage = 1;
        const totalPages = Math.ceil(data.length / rowsPerPage);

        function displayTable(page) {
            tableBody.innerHTML = "";

            const startIndex = (page - 1) * rowsPerPage;
            const endIndex = startIndex + rowsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            paginatedData.forEach(rowData => {
                let row;
                if (type === "executive") {
                    row = `
                        <tr>
                            <td>${rowData.name}</td>
                            <td>${rowData.birth || "N/A"}</td>
                            <td>${rowData.position}</td>
                            <td>${rowData.tenure || "N/A"}</td>
                        </tr>
                    `;
                } else {
                    row = `
                        <tr>
                            <td>${rowData.department || "N/A"}</td>
                            <td>${rowData.full_time_employee || 0}</td>
                            <td>${rowData.contract_worker || 0}</td>
                            <td>${rowData.total_staff || 0}</td>
                        </tr>
                    `;
                }
                tableBody.innerHTML += row;
            });

            // í˜ì´ì§€ ì •ë³´ ì—…ë°ì´íŠ¸
            pageInfo.textContent = `${currentPage} / ${totalPages}`;

            // ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages;
        }

        prevButton.addEventListener("click", function () {
            if (currentPage > 1) {
                currentPage--;
                displayTable(currentPage);
            }
        });

        nextButton.addEventListener("click", function () {
            if (currentPage < totalPages) {
                currentPage++;
                displayTable(currentPage);
            }
        });

        // ì²« ë²ˆì§¸ í˜ì´ì§€ ë Œë”ë§
        displayTable(currentPage);
    }

    // ğŸ“Œ ë²„íŠ¼ í´ë¦­ ì‹œ AJAX í˜¸ì¶œí•˜ì—¬ ë°ì´í„° ê°±ì‹ 
    buttons.forEach(button => {
        button.addEventListener("click", function () {
            let reportType = this.getAttribute("data-type");

            buttons.forEach(btn => btn.classList.remove("active"));
            this.classList.add("active");

            fetchFinancialData(reportType);
        });
    });
            // ğŸ“Œ ê¸°ë³¸ê°’: ì¬ë¬´ìƒíƒœí‘œ(BS_single) ìë™ ë¡œë“œ
            fetchFinancialData("BS_single");

            
        });
    </script>
    <script>
        // JSON ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    const financialResults = JSON.parse(document.getElementById("financialResultsData").textContent);

console.log("ì¬ë¬´ ë°ì´í„°:", financialResults);

// ë°ì´í„° 100ë§Œ ë‹¨ìœ„ë¡œ ë³€í™˜ (ê°’ì´ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ ëŒ€ì²´)
let predicted_2024 = (financialResults[0]["Predicted_2024"] ?? 0) / 1_000_000;
let actual_2023 = (financialResults[0]["Actual_2023"] ?? 0) / 1_000_000;
let actual_2022 = (financialResults[0]["Actual_2022"] ?? 0) / 1_000_000;
let actual_2021 = (financialResults[0]["Actual_2021"] ?? 0) / 1_000_000;

let myCt = document.getElementById('revenueChart').getContext('2d');

let myChart = new Chart(myCt, {
    type: 'bar',
    data: {
        labels: ['2021', '2022', '2023', '2024 ì˜ˆì¸¡'],
        datasets: [{
            label: 'ë§¤ì¶œ (ë‹¨ìœ„: ë°±ë§Œ)',
            data: [
                actual_2021,actual_2022,actual_2023,predicted_2024
            ],
            backgroundColor: [ 
                'rgba(70, 130, 180, 0.7)',  // ìŠ¤í‹¸ ë¸”ë£¨ (ì—°í•œ íˆ¬ëª…ë„)
                'rgba(70, 130, 180, 0.7)',
                'rgba(70, 130, 180, 0.7)',
                'rgba(70, 130, 180, 0.3)'  // ì—°í•œ ìŠ¤í‹¸ ë¸”ë£¨ (ì˜ˆì¸¡)
            ],
            borderColor: [
                'rgba(70, 130, 180, 1)',
                'rgba(70, 130, 180, 1)',
                'rgba(70, 130, 180, 1)',
                'rgba(70, 130, 180, 1)'
            ],
            borderWidth: 2,
            borderRadius: 5,
            borderDash: [5, 5],
            barPercentage: 0.8,
            categoryPercentage: 0.9
            },]
            
        }, options: {
                responsive: false,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: "rgba(200, 200, 200, 0.3)"  // ê·¸ë¦¬ë“œë¼ì¸
                },
                ticks: {
                    color: "#333"
                },
                x: {
                    ticks: {
                        color: "#333"
                    }
                }
                    }
                }
            }
        });
    </script>

</body>
</html>

